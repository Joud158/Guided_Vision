<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Guided Vision Dashboard</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --bg: #0f172a;
      --card: #020617;
      --mint: #3eb489;
      --danger: #f97373;
      --safe: #4ade80;
      --text-main: #e5e7eb;
      --text-muted: #9ca3af;
      --border: #1f2937;
    }

    * { box-sizing: border-box; margin: 0; padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
    }

    body {
      min-height: 100vh;
      background: radial-gradient(circle at top left, #1e293b, #020617 55%);
      color: var(--text-main);
      display: flex;
      justify-content: center;
      align-items: flex-start;
      padding: 24px;
    }

    .shell {
      width: 100%;
      max-width: 1080px;
      background: linear-gradient(145deg, rgba(15,23,42,0.96), rgba(2,6,23,0.96));
      border-radius: 24px;
      padding: 22px 24px 24px;
      box-shadow: 0 18px 45px rgba(0, 0, 0, 0.55);
      border: 1px solid rgba(148, 163, 184, 0.2);
    }

    header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 18px; }

    .title { display: flex; align-items: center; gap: 10px; }

    .title-icon {
      width: 38px; height: 38px;
      border-radius: 14px;
      background: radial-gradient(circle at 20% 0%, #22c55e, #22d3ee);
      display: flex; align-items: center; justify-content: center;
      box-shadow: 0 0 35px rgba(45, 212, 191, 0.5);
    }

    .title-text h1 { font-size: 20px; font-weight: 600; }
    .title-text p { font-size: 12px; color: var(--text-muted); }

    .pill {
      padding: 6px 10px; border-radius: 999px;
      background: rgba(15,23,42,0.7);
      border: 1px solid rgba(148,163,184,0.5);
      font-size: 11px; display: flex; align-items: center; gap: 6px;
    }

    .pill-dot { width: 8px; height: 8px; border-radius: 999px; background: #22c55e; }

    main {
      display: grid;
      grid-template-columns: minmax(0, 3fr) minmax(0, 2fr);
      gap: 18px;
    }

    .card {
      background: radial-gradient(circle at top left, rgba(30,64,175,0.22), rgba(15,23,42,0.98));
      border-radius: 18px; padding: 16px;
      border: 1px solid rgba(148,163,184,0.32);
    }

    .card-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px; }
    .card-title { font-size: 13px; text-transform: uppercase; color: var(--text-muted); }

    .mode-toggle { display: flex; gap: 3px; background: rgba(15,23,42,0.9); padding: 3px; border-radius: 999px; }
    .mode-btn { border: none; background: none; padding: 4px 10px; color: var(--text-muted); cursor: pointer; border-radius: 999px; }
    .mode-btn.active { background: linear-gradient(135deg, #22c55e, #0ea5e9); color: #020617; }

    .video-shell {
      position: relative;
      border-radius: 16px;
      overflow: hidden;
      border: 1px solid rgba(30,64,175,0.6);
      background: #020617;
      min-height: 210px; display: flex; justify-content: center; align-items: center;
    }

    video { width: 100%; display: none; }

    .video-placeholder { padding: 18px; color: var(--text-muted); text-align: center; }

    .controls { display: flex; justify-content: space-between; margin-top: 10px; }

    .primary-btn {
      border: none; padding: 8px 14px; border-radius: 999px;
      background: linear-gradient(135deg, #22c55e, #0ea5e9);
      cursor: pointer; color: #020617; font-weight: 600;
    }

    .status-row { display: flex; gap: 10px; margin-top: 12px; }

    .status-dot { width: 7px; height: 7px; border-radius: 50%; }
    .status-dot.idle { background: #aaa; }
    .status-dot.safe { background: var(--safe); }
    .status-dot.danger { background: var(--danger); }

    .mint-caption {
      margin-top: 10px;
      padding: 14px;
      border-radius: 18px;
      background: rgba(62,180,137,0.15);
      border: 1px solid rgba(62,180,137,0.7);
    }

    .side-card {
      background: radial-gradient(circle at top right, rgba(56,189,248,0.24), rgba(15,23,42,0.96));
      border-radius: 18px; padding: 16px;
    }
  </style>
</head>
<body>
<div class="shell">
  <header>
    <div class="title">
      <div class="title-icon"><span>üì∑</span></div>
      <div class="title-text">
        <h1>Guided Vision Dashboard</h1>
        <p>Compact hazard awareness for visually impaired users</p>
      </div>
    </div>
    <div class="pill">
      <span class="pill-dot"></span>
      <span id="serverStatus">Server: checking‚Ä¶</span>
    </div>
  </header>

  <main>
    <!-- LEFT card -->
    <section class="card">
      <div class="card-header">
        <div class="card-title">Input Source</div>
        <div class="mode-toggle">
          <button class="mode-btn active" id="modeLaptopBtn">üíª Laptop</button>
          <button class="mode-btn" id="modePiBtn">üì∑ Raspberry Pi</button>
        </div>
      </div>

      <div class="video-shell">
        <video id="video" autoplay muted playsinline></video>
        <div class="video-placeholder" id="videoPlaceholder">
          Click <strong>Start Capture</strong> to enable your webcam.
        </div>
        <canvas id="canvas" style="display:none;"></canvas>
      </div>

      <div class="controls">
        <button class="primary-btn" id="startBtn">‚ñ∂ Start Capture</button>
        <span class="hint">Frames sent every ~3 seconds</span>
      </div>

      <div class="status-row">
        <div><span class="status-dot idle" id="dangerDot"></span> 
          <span id="dangerLabel">Idle</span></div>
        <div>‚è± <span id="latencyLabel">Latency: ‚Äî ms</span></div>
        <div>üîÅ <span id="lastUpdatedLabel">Last update: ‚Äî</span></div>
      </div>

      <div class="mint-caption">
        <div class="mint-label">Detected sentence</div>
        <div class="mint-text" id="captionText">Waiting‚Ä¶</div>
        <div class="mint-sub" id="warningText">No hazard.</div>
      </div>
    </section>

    <!-- RIGHT -->
    <section class="side-card">
      <h3>Overview</h3>
      <p>
        Laptop webcam mode streams frames to <code>/analyze_frame</code>.<br>
        Raspberry Pi mode polls <code>/last_result</code>.
      </p>
    </section>
  </main>

  <footer>
    Guided Vision Dashboard 
  </footer>
</div>

<script>
const SERVER_URL = "http://127.0.0.1:8000";
let captureRunning = false;
let mediaStream = null;
let lastSpoken = 0;

// --- SPEAKING FUNCTION ---
function speakDanger(text) {
  const now = Date.now();
  if (now - lastSpoken < 3000) return; // avoid spam
  lastSpoken = now;

  const msg = new SpeechSynthesisUtterance("Watch out! " + text);
  msg.rate = 1;
  msg.pitch = 1;
  speechSynthesis.speak(msg);
}

// --- UPDATE UI ---
function updateUI(data) {
  document.getElementById("captionText").textContent =
    data.raw_caption || "Waiting‚Ä¶";

  document.getElementById("warningText").textContent =
    data.warning || "No hazard.";

  const isDanger = data.is_danger;
  const dot = document.getElementById("dangerDot");

  dot.className = "status-dot " + (isDanger ? "danger" : "safe");
  document.getElementById("dangerLabel").textContent =
    isDanger ? "Danger detected" : "Safe";

  if (isDanger && data.warning) {
    speakDanger(data.warning);
  }

  if (data.latency_ms != null) {
    const ms = Math.round(data.latency_ms);
    document.getElementById("latencyLabel").textContent =
      "Latency: " + ms + " ms";
  }
  document.getElementById("lastUpdatedLabel").textContent =
    "Last update: " + new Date().toLocaleTimeString();
}

// --- CAPTURE LOOP ---
async function startCapture() {
  try {
    mediaStream = await navigator.mediaDevices.getUserMedia({ video: true });
    const video = document.getElementById("video");
    video.srcObject = mediaStream;
    video.style.display = "block";
    document.getElementById("videoPlaceholder").style.display = "none";

    captureRunning = true;
    document.getElementById("startBtn").textContent = "‚èπ Stop";

    const canvas = document.getElementById("canvas");

    async function sendFrame() {
      if (!captureRunning) return;

      const ctx = canvas.getContext("2d");
      canvas.width = 480;
      canvas.height = 360;
      ctx.drawImage(video, 0, 0, canvas.width, canvas.height);

      const blob = await new Promise((res) =>
        canvas.toBlob(res, "image/jpeg", 0.7)
      );

      const form = new FormData();
      form.append("file", blob, "frame.jpg");

      const resp = await fetch(SERVER_URL + "/analyze_frame", {
        method: "POST",
        body: form,
      });

      if (resp.ok) updateUI(await resp.json());
      setTimeout(sendFrame, 3000);
    }

    sendFrame();
  } catch (err) {
    alert("Webcam error: " + err.message);
  }
}

function stopCapture() {
  captureRunning = false;
  document.getElementById("startBtn").textContent = "‚ñ∂ Start Capture";
  const video = document.getElementById("video");
  video.style.display = "none";
  document.getElementById("videoPlaceholder").style.display = "block";

  if (mediaStream) {
    mediaStream.getTracks().forEach((t) => t.stop());
    mediaStream = null;
  }
}

document.getElementById("startBtn").addEventListener("click", () => {
  if (captureRunning) stopCapture();
  else startCapture();
});

// Check server status
fetch(SERVER_URL + "/last_result")
  .then(() => (serverStatus.textContent = "Server: online"))
  .catch(() => (serverStatus.textContent = "Server: offline"));
</script>

</body>
</html>
